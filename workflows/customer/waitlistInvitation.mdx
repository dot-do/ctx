---
$type: Workflow
$id: workflow/waitlistinvitation
id: waitlist-invitation
name: Waitlist Invitation
description: Automated workflow for generating and sending beta invitations to waitlist members
category: growth
status: active
trigger: manual
inputs:
  - name: count
    type: number
    required: true
    description: Number of invitations to generate
    default: 50
  - name: priorityThreshold
    type: number
    required: false
    description: Minimum priority score (0-100)
    default: 70
  - name: excludeStatuses
    type: array
    required: false
    description: Waitlist statuses to exclude
    default: [invited, accepted, rejected]
  - name: expirationDays
    type: number
    required: false
    description: Days until invitation expires
    default: 7
  - name: sendReminder
    type: boolean
    required: false
    description: Send reminder 2 days before expiration
    default: true
  - name: dryRun
    type: boolean
    required: false
    description: Preview invitations without sending
    default: false
outputs:
  - name: invitationsGenerated
    type: number
    description: Number of invitations created
  - name: emailsSent
    type: number
    description: Number of invitation emails sent
  - name: failed
    type: number
    description: Number of failed email sends
  - name: dryRun
    type: boolean
    description: Whether this was a dry run
estimatedDuration: 1-5 minutes (depends on count)
---

# Waitlist Invitation Workflow

Automated workflow for selecting high-priority waitlist entries and sending beta invitations.

## Overview

**Purpose:** Generate and send beta invitations to waitlist members based on priority scoring, enabling phased beta launches.

**What happens:**
- Select top N waitlist entries by priority score
- Generate unique invitation codes
- Create invitation records
- Queue invitation emails for delivery
- Update waitlist entry statuses
- Track invitation metrics

**Use cases:**
- Weekly beta invitation batches
- Phased product launches
- Priority-based access control
- Referral program rewards

## Workflow Steps

### Step 1: Validate Input Parameters

**Action:** Validate workflow inputs

```typescript
const validated = {
  count: Math.min(Math.max(input.count || 50, 1), 1000), // 1-1000
  priorityThreshold: Math.min(Math.max(input.priorityThreshold || 70, 0), 100), // 0-100
  excludeStatuses: input.excludeStatuses || ['invited', 'accepted', 'rejected'],
  expirationDays: Math.min(Math.max(input.expirationDays || 7, 1), 30), // 1-30 days
  sendReminder: input.sendReminder !== false, // Default true
  dryRun: input.dryRun === true, // Default false
}

console.log('Generating invitations with config:', validated)
```

**Validation Rules:**
- **count**: 1-1000 (prevents overwhelming email system)
- **priorityThreshold**: 0-100 (valid score range)
- **expirationDays**: 1-30 days (reasonable time window)
- **dryRun**: Safety check for testing

### Step 2: Select Eligible Waitlist Entries

**Service:** `waitlist-beta-management`
**Action:** Query database for top-priority entries

```typescript
// Get eligible entries
const entries = await env.DB.execute(
  `SELECT * FROM waitlist_entries
   WHERE status NOT IN (${excludeStatuses.map(() => '?').join(',')})
   AND priority_score >= ?
   ORDER BY priority_score DESC, signed_up_at ASC
   LIMIT ?`,
  [...excludeStatuses, priorityThreshold, count]
)

console.log(`Found ${entries.rows.length} eligible entries`)

// Log selection criteria
console.log('Selection criteria:', {
  minScore: priorityThreshold,
  maxCount: count,
  excluded: excludeStatuses,
  topScore: entries.rows[0]?.priority_score,
  bottomScore: entries.rows[entries.rows.length - 1]?.priority_score,
})
```

**Selection Logic:**
1. Exclude already invited/accepted/rejected
2. Filter by minimum priority score
3. Sort by priority DESC, then signup date ASC
4. Limit to requested count

**Example Selection:**
```sql
-- Top 50 entries with score >= 70
SELECT id, email, name, priority_score
FROM waitlist_entries
WHERE status = 'pending'
AND priority_score >= 70
ORDER BY priority_score DESC, signed_up_at ASC
LIMIT 50;
```

### Step 3: Generate Invitation Codes

**Service:** `waitlist-beta-management`
**Action:** Create unique invite codes for each entry

```typescript
const invitations = []

for (const entry of entries.rows) {
  const inviteCode = generateInviteCode() // 12 chars, alphanumeric
  const expiresAt = new Date(Date.now() + expirationDays * 24 * 60 * 60 * 1000).toISOString()
  const now = new Date().toISOString()

  const invitation = {
    id: ulid(),
    waitlistEntryId: entry.id,
    inviteCode,
    email: entry.email,
    name: entry.name,
    status: 'pending',
    expiresAt,
    createdAt: now,
    updatedAt: now,
  }

  invitations.push(invitation)
}

console.log(`Generated ${invitations.length} invitation codes`)
```

**Code Generation:**
```typescript
function generateInviteCode(): string {
  const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789' // No ambiguous chars
  let code = ''
  for (let i = 0; i < 12; i++) {
    code += chars.charAt(Math.floor(Math.random() * chars.length))
  }
  return code
}
```

**Example Codes:**
- `ABC123XYZ789`
- `9ZK4MN7P2QRS`
- `BETA8LAUNCH3`

### Step 4: Save Invitation Records

**Service:** `db`
**Action:** Insert invitations into database

```typescript
for (const invitation of invitations) {
  await env.DB.execute(
    `INSERT INTO beta_invitations (
      id, waitlist_entry_id, invite_code, email, name,
      status, expires_at, created_at, updated_at
    ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)`,
    [
      invitation.id,
      invitation.waitlistEntryId,
      invitation.inviteCode,
      invitation.email,
      invitation.name,
      invitation.status,
      invitation.expiresAt,
      invitation.createdAt,
      invitation.updatedAt,
    ]
  )
}

console.log(`Saved ${invitations.length} invitations to database`)
```

**Database Record:**
```json
{
  "id": "01J5678XYZ1234ABC",
  "waitlistEntryId": "01J1234ABC5678XYZ",
  "inviteCode": "ABC123XYZ789",
  "email": "jane@startup.com",
  "name": "Jane Doe",
  "status": "pending",
  "expiresAt": "2025-10-10T10:00:00Z",
  "createdAt": "2025-10-03T10:00:00Z",
  "updatedAt": "2025-10-03T10:00:00Z"
}
```

### Step 5: Queue Invitation Emails

**Service:** `waitlist-beta-management`
**Action:** Queue emails for async delivery

```typescript
const summary = {
  generated: invitations.length,
  sent: 0,
  failed: 0,
}

if (!dryRun) {
  for (const invitation of invitations) {
    try {
      // Queue invitation email
      await env.WAITLIST_QUEUE.send({
        type: 'send_invitation',
        invitationId: invitation.id,
      })

      summary.sent++
    } catch (error) {
      console.error(`Failed to queue invitation for ${invitation.email}:`, error)
      summary.failed++
    }
  }

  console.log('Email queue summary:', summary)
} else {
  console.log('DRY RUN: No emails sent')
}
```

**Queue Message:**
```typescript
{
  type: 'send_invitation',
  invitationId: '01J5678XYZ1234ABC'
}
```

**Queue Processing:**
1. Fetch invitation from database
2. Render email template with personalized data
3. Send email via email service
4. Update invitation status to `sent`
5. Update `sentAt` timestamp

### Step 6: Update Waitlist Entry Statuses

**Service:** `db`
**Action:** Mark entries as invited

```typescript
const now = new Date().toISOString()

for (const invitation of invitations) {
  await env.DB.execute(
    `UPDATE waitlist_entries
     SET status = 'invited',
         invited_at = ?,
         updated_at = ?
     WHERE id = ?`,
    [now, now, invitation.waitlistEntryId]
  )
}

console.log(`Updated ${invitations.length} waitlist entries to 'invited' status`)
```

**Status Transition:**
```
waitlist_entry.status: pending → invited
```

### Step 7: Schedule Reminder Emails (Optional)

**Service:** `schedule`
**Action:** Queue reminder emails for 2 days before expiration

```typescript
if (sendReminder && !dryRun) {
  for (const invitation of invitations) {
    const reminderAt = new Date(invitation.expiresAt)
    reminderAt.setDate(reminderAt.getDate() - 2) // 2 days before expiration

    // Schedule reminder
    await env.SCHEDULE.scheduleJob({
      jobName: `reminder_${invitation.id}`,
      runAt: reminderAt.toISOString(),
      payload: {
        type: 'send_reminder',
        invitationId: invitation.id,
      },
      queue: 'waitlist-queue',
    })
  }

  console.log(`Scheduled ${invitations.length} reminder emails`)
}
```

**Reminder Schedule:**
- **Invitation sent**: Day 0
- **Reminder sent**: Day 5 (2 days before expiration)
- **Expires**: Day 7

### Step 8: Track Invitation Analytics

**Service:** `analytics`
**Action:** Track batch metrics

```typescript
await env.ANALYTICS.track({
  event: 'invitation_batch_generated',
  properties: {
    count: summary.generated,
    sent: summary.sent,
    failed: summary.failed,
    priorityThreshold,
    expirationDays,
    dryRun,
    topScore: entries.rows[0]?.priority_score,
    bottomScore: entries.rows[entries.rows.length - 1]?.priority_score,
  },
  timestamp: new Date().toISOString(),
})

console.log('Analytics tracked')
```

**Tracked Metrics:**
- Batch size
- Priority range
- Send success rate
- Dry run flag
- Timestamp

### Step 9: Return Workflow Results

**Action:** Return summary to caller

```typescript
return {
  invitationsGenerated: summary.generated,
  emailsSent: summary.sent,
  failed: summary.failed,
  dryRun,
  invitations: dryRun ? invitations : [], // Only return in dry run
}
```

**Success Response:**
```json
{
  "invitationsGenerated": 50,
  "emailsSent": 50,
  "failed": 0,
  "dryRun": false
}
```

**Dry Run Response:**
```json
{
  "invitationsGenerated": 50,
  "emailsSent": 0,
  "failed": 0,
  "dryRun": true,
  "invitations": [
    {
      "email": "jane@startup.com",
      "priorityScore": 85,
      "inviteCode": "ABC123XYZ789",
      "expiresAt": "2025-10-10T10:00:00Z"
    },
    // ... 49 more
  ]
}
```

## Invitation Email Template

**Subject:** `You're invited to the .do beta!`

**Body:**
```html
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <style>
    body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
    .container { max-width: 600px; margin: 0 auto; padding: 20px; }
    .header { text-align: center; margin-bottom: 30px; }
    .code { font-size: 24px; font-weight: bold; letter-spacing: 2px; color: #0066cc; text-align: center; margin: 20px 0; }
    .button { display: inline-block; padding: 12px 24px; background: #0066cc; color: white; text-decoration: none; border-radius: 4px; }
    .footer { margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee; font-size: 12px; color: #666; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>🎉 You're Invited!</h1>
    </div>

    <p>Hi {{name}},</p>

    <p>Congratulations! You've been selected for early access to the <strong>.do platform beta</strong>.</p>

    <p>Based on your priority score of <strong>{{priorityScore}}</strong>, you're among the first {{batchSize}} users to get beta access.</p>

    <div class="code">{{inviteCode}}</div>

    <p style="text-align: center;">
      <a href="{{inviteUrl}}" class="button">Redeem Your Invitation</a>
    </p>

    <p><strong>⏰ This invitation expires on {{expiresAt}}</strong> ({{expiresIn}}).</p>

    <p>We can't wait to see what you build!</p>

    <p>Best,<br>The .do Team</p>

    <div class="footer">
      <p>Need help? Reply to this email or visit our <a href="https://docs.do">documentation</a>.</p>
      <p>Your invitation code: {{inviteCode}}</p>
    </div>
  </div>
</body>
</html>
```

**Template Data:**
```typescript
{
  name: 'Jane Doe',
  priorityScore: 85,
  batchSize: 50,
  inviteCode: 'ABC123XYZ789',
  inviteUrl: 'https://app.do/invite/ABC123XYZ789',
  expiresAt: 'October 10, 2025 at 10:00 AM UTC',
  expiresIn: '7 days'
}
```

## Use Cases

### Weekly Beta Batch

**Scenario:** Send invitations every Friday to top 100 users

```bash
# Generate and send to top 100 with score >= 70
POST /workflows/waitlist-invitation
{
  "count": 100,
  "priorityThreshold": 70,
  "expirationDays": 7,
  "sendReminder": true,
  "dryRun": false
}
```

**Schedule:** Cron job every Friday at 10 AM UTC

### Launch Day Batch

**Scenario:** Invite first 500 users on launch day

```bash
# Preview first batch (dry run)
POST /workflows/waitlist-invitation
{
  "count": 500,
  "priorityThreshold": 60,
  "dryRun": true
}

# Review results, then send for real
POST /workflows/waitlist-invitation
{
  "count": 500,
  "priorityThreshold": 60,
  "dryRun": false
}
```

### Priority Batch

**Scenario:** Invite only top-tier users (score >= 90)

```bash
POST /workflows/waitlist-invitation
{
  "count": 50,
  "priorityThreshold": 90,
  "expirationDays": 14, # Longer expiration for VIPs
  "dryRun": false
}
```

### Referral Reward Batch

**Scenario:** Invite users who referred 5+ friends

```bash
# First, boost their priority scores
UPDATE waitlist_entries
SET priority_score = 100
WHERE id IN (
  SELECT referral_code FROM waitlist_entries
  WHERE referral_code IS NOT NULL
  GROUP BY referral_code
  HAVING COUNT(*) >= 5
);

# Then invite them
POST /workflows/waitlist-invitation
{
  "count": 100,
  "priorityThreshold": 100, # Only top referrers
  "dryRun": false
}
```

## Error Handling

### Common Errors

**No Eligible Entries**
```typescript
if (entries.rows.length === 0) {
  throw new Error(
    `No eligible entries found (minScore=${priorityThreshold}, count=${count})`
  )
}
```

**Queue Failure**
```typescript
try {
  await env.WAITLIST_QUEUE.send(message)
} catch (error) {
  console.error('Queue send failed:', error)
  summary.failed++
  // Continue processing remaining invitations
}
```

**Database Constraint Violation**
```typescript
try {
  await env.DB.execute(insertQuery, params)
} catch (error) {
  if (error.message.includes('UNIQUE constraint')) {
    console.warn('Duplicate invite code, regenerating')
    // Generate new code and retry
  } else {
    throw error
  }
}
```

### Retry Strategy

```typescript
// Retry queue sends with exponential backoff
const retries = [1000, 2000, 5000] // ms
for (const delay of retries) {
  try {
    await env.WAITLIST_QUEUE.send(message)
    break
  } catch (error) {
    await sleep(delay)
  }
}
```

## Monitoring

### Key Metrics

- **Invitation rate**: Invitations sent per week
- **Queue success rate**: (sent / generated) * 100
- **Priority distribution**: Min/max/avg scores in batch
- **Acceptance rate**: (accepted / sent) * 100 (tracked later)
- **Expiration rate**: (expired / sent) * 100 (tracked later)

### Alerts

**Critical:**
- Queue success rate <95% (email delivery issues)
- No eligible entries (waitlist exhausted)
- High failure rate (>10%)

**Warning:**
- Batch size <50% of requested (not enough high-priority users)
- Priority threshold too high (no users qualify)

**Info:**
- Dry run executed (for testing)
- Batch completed successfully

## Best Practices

### Timing
- **Weekly batches**: Predictable cadence, manageable volume
- **Friday mornings**: Users have weekend to accept
- **Avoid holidays**: Lower acceptance rates

### Batch Sizing
- **Start small**: 50 invitations in first batch
- **Scale gradually**: 100 → 200 → 500
- **Monitor acceptance**: If <30%, reduce batch size or improve targeting

### Priority Thresholds
- **Week 1**: 90+ (VIP users only)
- **Week 2-4**: 80+ (high-priority users)
- **Week 5-8**: 70+ (good users)
- **Week 9+**: 60+ (all qualified users)

### Expiration Windows
- **Standard**: 7 days
- **VIP**: 14 days (top 10% priority)
- **Last call**: 3 days (waitlist exhausted, urgency)

## Success Metrics

**Week 1:**
- 50 invitations sent
- 100% queue success
- >30% acceptance rate

**Month 1:**
- 500 invitations sent
- <5% failure rate
- >40% acceptance rate

**Month 3:**
- 2,000+ invitations sent
- 80%+ of waitlist invited
- >50% acceptance rate
- Ready for public launch

## Related Workflows

- **referral-reward-distribution** - Boost priority for top referrers
- **deliverability-monitoring** - Monitor email delivery rates
- **campaign-creation** - Launch email campaigns to beta users

## Related Services

- **waitlist-beta-management** - Core invitation logic
- **email** - Send invitation emails
- **schedule** - Schedule reminder emails
- **analytics** - Track invitation metrics

## Related Schemas

- **waitlist-entry** - Source of recipients
- **beta-invitation** - Invitation records
- **referral-code** - Referral tracking
