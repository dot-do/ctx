---
$type: Worker
$id: utils
name: utils
main: src/index.ts
compatibility_date: "2025-07-08"
account_id: b6641681fe423910342b9ffa1364c76d

observability:
  enabled: true

ai:
  binding: ai
---

# Utils Worker

A Cloudflare Worker that provides utility functions for ID conversion and markdown processing via both HTTP and RPC interfaces.

## Features

- ✅ **ULID ↔ Sqid Conversion** - Convert between ULID and Sqid formats
- ✅ **toMarkdown** - Access Workers AI markdown conversion
- ✅ **HTTP API** - Call functions via URL query parameters
- ✅ **RPC Interface** - Service-to-service communication
- ✅ **Auto-Discovery** - Lists available functions at root

## Available Functions

### ID Conversion

- **ulidToSqid** - Convert ULID to Sqid format
- **sqidToUlid** - Convert Sqid back to ULID format

### Markdown Processing

- **toMarkdown** - Convert content to markdown using Workers AI

## Usage

### HTTP API

```bash
# List available functions
curl https://utils.do/

# Convert ULID to Sqid
curl "https://utils.do/ulidToSqid?u=01ARZ3NDEKTSV4RRFFQ69G5FAV"

# Convert Sqid to ULID
curl "https://utils.do/sqidToUlid?id=abc123"

# Convert to markdown (via AI binding)
curl "https://utils.do/toMarkdown?blob=..."
```

### RPC Interface

```ts
// In your wrangler.jsonc
{
  "services": [
    { "binding": "UTILS_SERVICE", "service": "utils" }
  ]
}

// In your worker
const sqid = await env.UTILS_SERVICE.ulidToSqid('01ARZ3NDEKTSV4RRFFQ69G5FAV')
const ulid = await env.UTILS_SERVICE.sqidToUlid('abc123')
const markdown = await env.UTILS_SERVICE.toMarkdown({ blob })
```

## ID Formats

### ULID (Universally Unique Lexicographically Sortable Identifier)

- **Format**: 26-character Crockford Base32
- **Example**: `01ARZ3NDEKTSV4RRFFQ69G5FAV`
- **Components**:
  - 10 chars: Timestamp (48 bits, millisecond precision)
  - 16 chars: Randomness (80 bits)
- **Benefits**: Sortable, URL-safe, collision-resistant

### Sqid (Sqids - Short Unique IDs)

- **Format**: Variable-length alphanumeric
- **Example**: `abc123xyz`
- **Benefits**: Shorter, customizable alphabet, aesthetic
- **Use case**: Public-facing IDs, URLs

### Conversion

The worker converts between formats while preserving:
- **Timestamp** - Original creation time from ULID
- **Randomness** - Full 80 bits of entropy
- **Reversibility** - Bidirectional conversion

## Implementation

```typescript
import { WorkerEntrypoint, env } from 'cloudflare:workers'
import { decodeTime, encodeTime, isValid } from 'ulid'
import Sqids from 'sqids'

// Sqids instance for ID conversion
const sqids = new Sqids({
  // optional: customise alphabet / minLength for aesthetics
  // alphabet: '0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ',
  // minLength: 22
})

// Base32 conversion helpers
const CROCKFORD32 = '0123456789ABCDEFGHJKMNPQRSTVWXYZ'
const lookup32 = [...CROCKFORD32].reduce((m, c, i) => (m[c] = i, m), {} as Record<string, number>)

function base32ChunkToBigInt(chunk: string): bigint {
  let b = 0n
  for (const ch of chunk) b = (b << 5n) | BigInt(lookup32[ch])
  return b
}

function bigIntToBase32(b: bigint, length: number): string {
  const out: string[] = Array(length)
  for (let i = length - 1; i >= 0; --i) {
    out[i] = CROCKFORD32[Number(b & 31n)]
    b >>= 5n
  }
  return out.join('')
}

// Utility functions
export function ulidToSqid(args: { u?: string }): string {
  const u = args.u || ''
  if (!isValid(u)) throw new Error('Invalid ULID')

  const t48 = decodeTime(u)
  const randBig = base32ChunkToBigInt(u.slice(10))
  const hi = Number(randBig >> 40n)
  const lo = Number(randBig & ((1n << 40n) - 1n))

  return sqids.encode([t48, hi, lo])
}

export function sqidToUlid(args: { id?: string }): string {
  const id = args.id || ''
  const [t48, hi, lo] = sqids.decode(id)
  if (t48 === undefined) throw new Error('Bad Sqid')

  const randBig = (BigInt(hi) << 40n) | BigInt(lo)
  const tsPart = encodeTime(t48)
  const randPart = bigIntToBase32(randBig, 16)

  return tsPart + randPart
}

export const toMarkdown = env?.ai?.toMarkdown as any

// Collect all exported functions
const pkg = { ulidToSqid, sqidToUlid, toMarkdown }

// RPC class with dynamic method binding
class RPC extends WorkerEntrypoint {
  constructor() {
    super({} as any, {} as any)
  }

  async fetch(request: Request) {
    const { origin, pathname, searchParams } = new URL(request.url)
    const args = Object.fromEntries(searchParams)
    const fn = pathname.slice(1)

    if (pkg[fn as keyof typeof pkg]) {
      try {
        return Response.json(await pkg[fn as keyof typeof pkg](args))
      } catch (error) {
        return Response.json({ success: false, error: (error as Error).message })
      }
    }

    return Response.json(Object.keys(pkg).map((key) => origin + '/' + key))
  }
}

// Bind functions to RPC prototype
for (const key of Object.keys(pkg)) {
  const desc = {
    enumerable: false,
    configurable: true,
    get() {
      return pkg[key as keyof typeof pkg]
    },
  }
  Object.defineProperty(RPC.prototype, key, desc)
}

export default RPC
```

## Utility Functions

### ULID ↔ Sqid Conversion

The worker converts between ULID and Sqid formats while preserving timestamp and randomness. See implementation above for the conversion logic.

### Markdown Conversion

The worker provides access to Workers AI's `toMarkdown` function for converting various content formats to markdown.

## Dependencies

- `ulid` - ULID generation and parsing
- `sqids` - Sqids generation (short IDs)
- Workers AI binding - Markdown conversion

## Use Cases

1. **Public-Facing IDs** - Convert internal ULIDs to prettier Sqids for URLs
2. **Database Keys** - Use ULIDs internally for sorting, Sqids publicly
3. **URL Shortening** - Generate short, readable IDs
4. **AI Content Processing** - Convert various formats to markdown
5. **Cross-Service Utilities** - Shared functions available via RPC

## Response Format

### Success

```json
{
  "result": "abc123xyz"
}
```

### Error

```json
{
  "success": false,
  "error": "Invalid ULID"
}
```

### Function List

```json
[
  "https://utils.do/ulidToSqid",
  "https://utils.do/sqidToUlid",
  "https://utils.do/toMarkdown"
]
```
