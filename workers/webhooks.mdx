---
$type: Worker
$id: webhooks
name: webhooks
main: worker.ts
compatibility_date: "2025-07-08"
workers_dev: false
account_id: b6641681fe423910342b9ffa1364c76d

compatibility_flags:
  - nodejs_compat

observability:
  enabled: true

tail_consumers:
  - service: pipeline

services:
  - binding: DB
    service: db
  - binding: QUEUE
    service: queue

queues:
  consumers:
    - queue: github-sync
      max_batch_size: 10
      max_batch_timeout: 5
      max_retries: 3
      dead_letter_queue: github-sync-dlq
---

# Webhooks Service

Comprehensive webhook processing and bi-directional GitHub synchronization microservice for the dot-do platform, handling webhooks from 4 external providers with 25+ event types.

## Overview

The **Webhooks Service** is a core integration service that receives and processes webhooks from external services, providing idempotent event processing, signature verification, and bi-directional GitHub sync with conflict resolution.

**Design Philosophy**: Single responsibility - webhook processing and synchronization only. No business logic beyond event routing. Pure integration service.

## Features

### 1. Multi-Provider Webhook Support (4 Providers)

**Stripe**:
- Payment intents (succeeded, failed, processing)
- Subscriptions (created, updated, deleted, trial ending)
- Invoices (paid, failed, finalized)
- Customers (created, updated, deleted)
- Signature verification (Stripe webhook secret)
- **9 event types**

**WorkOS**:
- Directory sync (user created, updated, deleted)
- Group sync (group created, updated, deleted)
- SSO events (authentication, profile update)
- Audit log events
- Signature verification (WorkOS webhook secret)
- **6 event types**

**GitHub**:
- Push events (MDX file changes → database sync)
- Pull request events (opened, closed, merged)
- Issue events (opened, closed, labeled)
- Release events (published, deleted)
- Signature verification (HMAC-SHA256)
- **6 event types**

**Resend** (via Svix):
- Email sent/delivered/bounced
- Email opened/clicked
- Unsubscribe events
- Signature verification (Svix webhook secret)
- **4 event types**

**Total**: 4 providers, 25+ event types

### 2. Bi-Directional GitHub Sync

**Architecture**:
```
GitHub Push Event (Webhook)
         ↓
    Webhooks Service
         ↓
   MDX → Database

Database Change
         ↓
      Queue
         ↓
    Webhooks Service
         ↓
   Database → GitHub
```

**Three Sync Modes**:

1. **GitHub → Database** (Webhook Handler):
   - Receives push events from GitHub
   - Parses MDX files with MDXLD format
   - Extracts `$id`, `$type`, and content
   - Updates database entities
   - Stores GitHub SHA for conflict detection

2. **Database → GitHub** (RPC Method):
   - Called by API service on database changes
   - Generates MDX file from database entity
   - Commits to GitHub via Octokit
   - Stores commit SHA in database
   - Supports branch selection and PR creation

3. **Automatic Queue-Based** (Queue Consumer):
   - Database triggers queue message on entity change
   - Queue consumer auto-syncs to GitHub
   - Configurable sync strategy (immediate, batched, manual)
   - Retry logic with exponential backoff

**MDXLD Format** (MDX Linked Data):
All MDX files use `$id` and `$type` fields for entity identification:

```yaml
---
$id: note/2025-10-03-implementation
$type: Note
title: Implementation Plan
author: Nathan Clevenger
tags: [planning, architecture]
---

# Implementation Notes

Content here...
```

### 3. Conflict Resolution (4 Strategies)

**Conflict Detection**:
- Compares database SHA with GitHub SHA
- Detects divergence when both versions changed
- Stores conflict in `sync_conflicts` table
- Alerts via email or Slack

**Resolution Strategies**:

1. **ours** - Use database version, force push to GitHub
2. **theirs** - Use GitHub version, update database
3. **merge** - Attempt three-way merge (database takes precedence)
4. **manual** - Mark for manual resolution, notify admin

**Conflict Tracking**:
```sql
CREATE TABLE sync_conflicts (
  id TEXT PRIMARY KEY,
  ns TEXT NOT NULL,
  entity_id TEXT NOT NULL,
  repository TEXT NOT NULL,
  path TEXT NOT NULL,
  branch TEXT NOT NULL DEFAULT 'main',
  database_sha TEXT NOT NULL,
  github_sha TEXT NOT NULL,
  database_content TEXT NOT NULL,
  github_content TEXT NOT NULL,
  created_at INTEGER NOT NULL,
  status TEXT NOT NULL DEFAULT 'pending',
  strategy TEXT,
  resolved_at INTEGER,
  error TEXT
);
```

### 4. Idempotent Event Processing

**Duplicate Detection**:
- Store webhook event ID in database before processing
- Check idempotency before processing
- Return `{ already_processed: true }` for duplicates
- No duplicate processing even on retries

**Event Storage**:
```sql
CREATE TABLE webhook_events (
  id TEXT PRIMARY KEY,
  provider TEXT NOT NULL,
  event_id TEXT UNIQUE NOT NULL,
  event_type TEXT NOT NULL,
  payload TEXT NOT NULL,  -- JSON string
  signature TEXT,
  processed BOOLEAN DEFAULT FALSE,
  processed_at TIMESTAMP,
  error TEXT,
  created_at TIMESTAMP DEFAULT NOW()
);
```

### 5. Signature Verification

**Stripe**:
- HMAC-SHA256 signature in `stripe-signature` header
- Verify with `STRIPE_WEBHOOK_SECRET`
- Timestamp tolerance: 5 minutes

**WorkOS**:
- HMAC-SHA256 signature in `workos-signature` header
- Verify with `WORKOS_WEBHOOK_SECRET`
- Timestamp tolerance: 5 minutes

**GitHub**:
- HMAC-SHA256 signature in `x-hub-signature-256` header
- Verify with `GITHUB_WEBHOOK_SECRET`
- No timestamp check (replay attacks mitigated by idempotency)

**Resend** (Svix):
- Ed25519 signature in `svix-signature` header
- Verify with `RESEND_WEBHOOK_SECRET` (Svix signing secret)
- Timestamp in `svix-timestamp` header (5 minute tolerance)

### 6. Queue Integration

**GitHub Sync Queue**:
- Queue name: `github-sync`
- Batch size: 10 messages
- Batch timeout: 5 seconds
- Max retries: 3
- Dead letter queue: `github-sync-dlq`

**Queue Message Format**:
```json
{
  "type": "github-sync",
  "payload": {
    "repository": "dot-do/notes",
    "path": "test-note.mdx",
    "content": "...",
    "message": "Update test-note.mdx",
    "branch": "main",
    "entityId": "note/test-note",
    "sha": "abc123..."
  }
}
```

### 7. Multi-Interface Support

**HTTP API** (Webhook Receivers):
- `/stripe` - Stripe webhook receiver
- `/workos` - WorkOS webhook receiver
- `/github` - GitHub webhook receiver
- `/resend` - Resend webhook receiver
- `/api/events` - List webhook events
- `/api/events/:provider/:eventId` - Get event details
- `/api/events/:provider/:eventId/retry` - Retry failed webhook

**RPC Interface** (Service-to-Service):
- `syncToGitHub(options)` - Sync entity to GitHub
- `resolveConflict(conflictId, strategy)` - Resolve sync conflict

**Queue Handler** (Async Processing):
- `queue(batch)` - Process GitHub sync queue messages

## Architecture

```
External Service (Stripe, WorkOS, GitHub, Resend)
                 ↓ Webhook
         ┌───────────────┐
         │   Webhooks    │
         │   Service     │
         │               │
         │  ┌─────────┐  │
         │  │Signature│  │ ◄── Verify webhook authenticity
         │  │  Verify │  │
         │  └─────────┘  │
         │               │
         │  ┌─────────┐  │
         │  │Idempot- │  │ ◄── Prevent duplicate processing
         │  │  ency   │  │
         │  └─────────┘  │
         │               │
         │  ┌─────────┐  │
         │  │ Handler │  │ ◄── Route to provider handler
         │  └─────────┘  │
         │               │
         │  ┌─────────┐  │
         │  │ GitHub  │  │ ◄── Bi-directional sync
         │  │  Sync   │  │
         │  └─────────┘  │
         │               │
         │  ┌─────────┐  │
         │  │Conflict │  │ ◄── Resolve conflicts
         │  │ Resolve │  │
         │  └─────────┘  │
         └───────┬───────┘
                 │
        ┌────────┴────────┐
        │                 │
        ▼                 ▼
   ┌────────┐       ┌─────────┐
   │   DB   │       │  QUEUE  │
   │(Events)│       │ (Sync)  │
   └────────┘       └─────────┘
```

## API

### RPC Interface (Service-to-Service)

#### GitHub Sync

```typescript
syncToGitHub(options: SyncToGitHubOptions): Promise<SyncResult>
```

Sync entity from database to GitHub.

**Input**:
```ts
{
  repository: string      // e.g., 'dot-do/notes'
  path: string           // e.g., 'test-note.mdx'
  content: string        // MDX content with MDXLD frontmatter
  message: string        // Commit message
  branch?: string        // Default: 'main'
  createPR?: boolean     // Create PR instead of direct commit
}
```

**Response**:
```ts
{
  success: boolean
  sha: string            // Commit SHA
  url: string            // GitHub file URL
  prUrl?: string         // PR URL if createPR=true
}
```

**Example**:
```ts
const result = await env.WEBHOOKS.syncToGitHub({
  repository: 'dot-do/notes',
  path: 'test-note.mdx',
  content: '---\n$id: note/test-note\n$type: Note\n---\n\nContent',
  message: 'Update test-note.mdx',
  branch: 'main',
  createPR: false
})
```

#### Conflict Resolution

```typescript
resolveConflict(conflictId: string, strategy: ConflictStrategy): Promise<ConflictResolution>
```

Resolve sync conflict with chosen strategy.

**Strategy**: `'ours' | 'theirs' | 'merge' | 'manual'`

**Response**:
```ts
{
  success: boolean
  conflictId: string
  strategy: string
  resolution: 'database' | 'github' | 'merged' | 'pending'
  sha?: string           // New commit SHA if resolved
}
```

**Example**:
```ts
const resolution = await env.WEBHOOKS.resolveConflict(
  'conflict_123',
  'ours' // Use database version
)
```

### HTTP API Endpoints

#### Webhook Receivers

**POST /stripe**

Receive Stripe webhook.

Headers:
- `stripe-signature` - Stripe webhook signature

Body: Raw Stripe event JSON

Response:
```json
{
  "received": true,
  "eventId": "evt_123",
  "eventType": "payment_intent.succeeded"
}
```

**POST /workos**

Receive WorkOS webhook.

Headers:
- `workos-signature` - WorkOS webhook signature

Body: Raw WorkOS event JSON

Response:
```json
{
  "received": true,
  "eventId": "evt_456",
  "eventType": "dsync.user.created"
}
```

**POST /github**

Receive GitHub webhook.

Headers:
- `x-hub-signature-256` - GitHub webhook signature (HMAC-SHA256)
- `x-github-event` - Event type (e.g., 'push', 'pull_request')
- `x-github-delivery` - Delivery ID (for idempotency)

Body: Raw GitHub event JSON

Response:
```json
{
  "received": true,
  "eventId": "delivery_789",
  "eventType": "push",
  "synced": true,
  "files": ["notes/test.mdx"],
  "entities": ["note/test"]
}
```

**POST /resend**

Receive Resend webhook (via Svix).

Headers:
- `svix-signature` - Svix webhook signature (Ed25519)
- `svix-id` - Event ID
- `svix-timestamp` - Timestamp

Body: Raw Resend event JSON

Response:
```json
{
  "received": true,
  "eventId": "msg_123",
  "eventType": "email.delivered"
}
```

#### Management Endpoints

**GET /api/events**

List webhook events.

Query parameters:
- `provider` - Filter by provider (stripe, workos, github, resend)
- `processed` - Filter by processed status (true, false)
- `limit` - Maximum number of events (default: 100)

Response:
```json
{
  "events": [
    {
      "id": "webhook_123",
      "provider": "github",
      "event_id": "delivery_789",
      "event_type": "push",
      "payload": "{...}",
      "signature": "sha256=...",
      "processed": true,
      "processed_at": "2025-01-08T12:00:00Z",
      "created_at": "2025-01-08T12:00:00Z"
    }
  ],
  "count": 1
}
```

**GET /api/events/:provider/:eventId**

Get webhook event details.

Response:
```json
{
  "id": "webhook_123",
  "provider": "github",
  "event_id": "delivery_789",
  "event_type": "push",
  "payload": "{...}",
  "signature": "sha256=...",
  "processed": true,
  "processed_at": "2025-01-08T12:00:00Z",
  "created_at": "2025-01-08T12:00:00Z"
}
```

**POST /api/events/:provider/:eventId/retry**

Retry failed webhook.

Response:
```json
{
  "success": true,
  "result": {
    "processed": true,
    "eventType": "push"
  }
}
```

## Configuration

### Secrets

Set via `wrangler secret put`:

```bash
# Stripe
wrangler secret put STRIPE_SECRET_KEY
wrangler secret put STRIPE_WEBHOOK_SECRET

# WorkOS
wrangler secret put WORKOS_API_KEY
wrangler secret put WORKOS_WEBHOOK_SECRET

# GitHub
wrangler secret put GITHUB_TOKEN
wrangler secret put GITHUB_WEBHOOK_SECRET

# Resend
wrangler secret put RESEND_API_KEY
wrangler secret put RESEND_WEBHOOK_SECRET
```

### Webhook URLs

Configure in external services:

**Stripe**:
- URL: `https://webhooks.do/stripe`
- Events to send: `payment_intent.*`, `subscription.*`, `invoice.*`, `customer.*`

**WorkOS**:
- URL: `https://webhooks.do/workos`
- Events to send: `dsync.*`, `sso.*`, `audit_log.*`

**GitHub**:
- URL: `https://webhooks.do/github`
- Events to send: `push`, `pull_request`, `issues`, `release`
- Content type: `application/json`
- Secret: `GITHUB_WEBHOOK_SECRET`

**Resend**:
- URL: `https://webhooks.do/resend`
- Events to send: `email.*`
- Svix signing secret: `RESEND_WEBHOOK_SECRET`

### Database Schema

Required tables (managed by DB service):

```sql
-- Webhook Events
CREATE TABLE webhook_events (
  id TEXT PRIMARY KEY,
  provider TEXT NOT NULL,
  event_id TEXT UNIQUE NOT NULL,
  event_type TEXT NOT NULL,
  payload TEXT NOT NULL,
  signature TEXT,
  processed BOOLEAN DEFAULT FALSE,
  processed_at TIMESTAMP,
  error TEXT,
  created_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_webhook_events_provider ON webhook_events(provider);
CREATE INDEX idx_webhook_events_event_id ON webhook_events(event_id);
CREATE INDEX idx_webhook_events_processed ON webhook_events(processed);

-- Sync Conflicts
CREATE TABLE sync_conflicts (
  id TEXT PRIMARY KEY,
  ns TEXT NOT NULL,
  entity_id TEXT NOT NULL,
  repository TEXT NOT NULL,
  path TEXT NOT NULL,
  branch TEXT NOT NULL DEFAULT 'main',
  database_sha TEXT NOT NULL,
  github_sha TEXT NOT NULL,
  database_content TEXT NOT NULL,
  github_content TEXT NOT NULL,
  created_at INTEGER NOT NULL,
  status TEXT NOT NULL DEFAULT 'pending',
  strategy TEXT,
  resolved_at INTEGER,
  error TEXT
);

CREATE INDEX idx_sync_conflicts_entity_id ON sync_conflicts(entity_id);
CREATE INDEX idx_sync_conflicts_status ON sync_conflicts(status);
```

## Event Handlers

All event handlers are implemented in `src/handlers/`:

- `stripe.ts` - Stripe event handler (9 event types)
- `workos.ts` - WorkOS event handler (6 event types)
- `github.ts` - GitHub event handler (6 event types) + sync logic
- `resend.ts` - Resend event handler (4 event types)

### Event Handler Pattern

Each handler follows the same pattern:

```ts
export async function handleProviderWebhook(
  event: ProviderEvent,
  env: Env
): Promise<any> {
  switch (event.type) {
    case 'event.type.1':
      return await handleEventType1(event.data, env)
    case 'event.type.2':
      return await handleEventType2(event.data, env)
    default:
      console.warn(`Unhandled event type: ${event.type}`)
      return { received: true, handled: false }
  }
}
```

## Security

### Signature Verification

**Critical**: ALL webhooks MUST verify signatures before processing.

**Verification Process**:
1. Extract signature from request headers
2. Compute expected signature using secret
3. Compare signatures in constant time
4. Reject if signatures don't match (401 Unauthorized)

**Implementation**:
```ts
// Stripe
const event = await verifyStripeSignature(
  rawBody,
  signature,
  env.STRIPE_WEBHOOK_SECRET
)

// WorkOS
const event = await verifyWorkOSSignature(
  rawBody,
  signature,
  env.WORKOS_WEBHOOK_SECRET
)

// GitHub
await verifyGitHubSignature(
  rawBody,
  signature,
  env.GITHUB_WEBHOOK_SECRET
)

// Resend (Svix)
const event = await verifyResendSignature(
  rawBody,
  headers,
  env.RESEND_WEBHOOK_SECRET
)
```

### Idempotency

**Critical**: ALL webhooks MUST check idempotency before processing.

**Implementation**:
```ts
// Check if already processed
const existing = await checkIdempotency(
  env.DB,
  'github',
  deliveryId
)
if (existing) {
  return c.json({ already_processed: true })
}

// Store event
await storeWebhookEvent(env.DB, {
  provider: 'github',
  eventId: deliveryId,
  eventType,
  payload: rawBody,
  signature
})

// Process event
const result = await handleGitHubWebhook(eventType, payload, env)

// Mark as processed
await markWebhookProcessed(env.DB, 'github', deliveryId)
```

### GitHub Sync Security

**Repository Access**:
- GitHub token must have `repo` scope
- Only sync to authorized repositories
- Validate repository ownership
- Check branch protection rules

**Conflict Resolution**:
- Never lose data during conflicts
- Always store both versions before resolution
- Alert on conflicts requiring manual resolution
- Audit all conflict resolutions

## Implementation

Due to the complexity of this service (~2,114 LOC across 15 files), the implementation is organized into focused modules:

- `src/index.ts` - HTTP API and RPC interface (primary)
- `worker.ts` - Main entrypoint (exports HTTP and queue handlers)
- `src/types.ts` - TypeScript type definitions
- `src/utils.ts` - Shared utility functions
- `src/conflicts.ts` - Conflict detection and resolution (467 LOC)
- `src/queue.ts` - Queue consumer for GitHub sync (184 LOC)
- `src/handlers/stripe.ts` - Stripe webhook handler
- `src/handlers/workos.ts` - WorkOS webhook handler
- `src/handlers/github.ts` - GitHub webhook handler + sync logic
- `src/handlers/resend.ts` - Resend webhook handler
- `src/handlers/index.ts` - Handler exports
- `src/verification/stripe.ts` - Stripe signature verification
- `src/verification/workos.ts` - WorkOS signature verification
- `src/verification/github.ts` - GitHub signature verification
- `src/verification/resend.ts` - Resend signature verification
- `src/verification/index.ts` - Verification exports

**Note**: This is a core integration service that must remain stable and secure. Changes require thorough testing and review.

## Testing

```bash
# Run test suite
pnpm test

# Watch mode
pnpm test -- --watch

# Coverage report
pnpm test -- --coverage
```

**Test Coverage**: 10 tests with 80%+ coverage

**Test Categories**:
- Signature verification for all providers
- Idempotency checking
- Event handler routing
- GitHub sync (database ↔ GitHub)
- Conflict detection and resolution
- Queue consumer processing

## Performance

**Target Metrics**:
- Webhook processing: <50ms (p95) from receipt to acknowledgment
- GitHub sync: <200ms (p95) for single file
- Queue processing: <500ms (p95) for batch of 10
- Conflict resolution: <100ms (p95)

**Optimizations**:
- Signature verification cached when possible
- Idempotency check uses database index
- GitHub API calls batched when possible
- Queue processing runs in parallel
- Conflict detection uses SHA comparison (fast)

## Monitoring

**Health Check**:
```bash
curl https://webhooks.do/
```

**Metrics**:
- Webhook processing success/failure rate per provider
- Signature verification failures (security alert)
- Idempotency cache hit rate
- GitHub sync success/failure rate
- Conflict detection rate
- Queue processing latency

**Logging**:
- All webhook events logged
- Signature verification results
- GitHub sync operations
- Conflict detections and resolutions
- Queue processing status
- Failed webhooks with error messages

## Troubleshooting

### Webhook not processing

1. Check signature verification is passing
2. Verify webhook secret is correct
3. Check idempotency (may be duplicate)
4. Review error in webhook_events table
5. Retry failed webhook: `POST /api/events/:provider/:eventId/retry`

### GitHub sync failing

1. Check GitHub token has correct permissions
2. Verify repository exists and is accessible
3. Check branch exists or is default branch
4. Review conflict status
5. Check GitHub API rate limits

### Conflict resolution not working

1. Check conflict exists in sync_conflicts table
2. Verify strategy is valid ('ours', 'theirs', 'merge', 'manual')
3. Review database and GitHub SHAs
4. Check for merge conflicts in content
5. Use manual resolution if automatic fails

### Queue messages not processing

1. Check queue consumer is deployed
2. Verify queue binding is correct
3. Review dead letter queue for failed messages
4. Check message format is correct
5. Review queue consumer logs for errors

## Related Services

- **DB Service** - Webhook event and conflict storage
- **Queue Service** - Async GitHub sync processing
- **GitHub** - Repository hosting and webhook provider
- **Stripe, WorkOS, Resend** - External webhook providers

## References

- [Stripe Webhooks](https://stripe.com/docs/webhooks)
- [WorkOS Webhooks](https://workos.com/docs/webhooks)
- [GitHub Webhooks](https://docs.github.com/en/webhooks)
- [Resend Webhooks](https://resend.com/docs/webhooks)
- [Svix Webhook Verification](https://docs.svix.com/receiving/verifying-payloads/how)
- [Cloudflare Queues](https://developers.cloudflare.com/queues/)

---

**Service Type**: Core Integration
**LOC**: ~2,114 across 15 files
**Test Coverage**: 10 tests, 80%+ coverage
**Status**: Production Ready
**Last Updated**: 2025-10-04
